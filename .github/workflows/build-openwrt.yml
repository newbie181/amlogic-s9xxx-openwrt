name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Select the OpenWrt source"
        required: true
        default: "openwrt-main"
        type: choice
        options:
          - openwrt-main
          - lede-master
          - immortalwrt-master
      openwrt_board:
        description: "Target board"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - s905x
          - s912
          - rock5b
          - orangepi-5-plus
      openwrt_kernel:
        description: "Kernel version"
        required: false
        default: "6.1.y_6.12.y"
        type: choice
        options:
          - 5.4.y
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y
          - 5.4.y_5.10.y
          - 5.15.y_6.1.y
          - 6.1.y_6.12.y
      auto_kernel:
        description: "Use latest kernel automatically"
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Jakarta

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout workflow
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang clang++ flex g++ gawk gcc-multilib \
            help2man texinfo libtool libncurses5-dev libncursesw5-dev zlib1g-dev \
            file wget unzip python3 python3-distutils rsync subversion asciidoc \
            libssl-dev libelf-dev ecj fastjar java-propose-classpath \
            libglib2.0-dev xmlto ccache ninja-build

      - name: Clone OpenWrt Source
        run: |
          case "${{ inputs.source_branch }}" in
            openwrt-main)
              git clone --depth 1 --branch master https://github.com/openwrt/openwrt.git openwrt
              ;;
            lede-master)
              git clone --depth 1 --branch master https://github.com/coolsnowwolf/lede.git openwrt
              ;;
            immortalwrt-master)
              git clone --depth 1 --branch master https://github.com/immortalwrt/immortalwrt.git openwrt
              ;;
            *)
              echo "Unknown source_branch: ${{ inputs.source_branch }}"
              exit 1
              ;;
          esac

      - name: Update and Install Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure default config
        run: |
          cd openwrt
          make defconfig

      - name: Build OpenWrt Firmware
        run: |
          cd openwrt
          make -j$(nproc) V=s
          
